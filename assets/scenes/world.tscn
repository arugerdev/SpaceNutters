[gd_scene load_steps=25 format=3 uid="uid://chtdw4foyxy4g"]

[ext_resource type="Texture2D" uid="uid://bv68tj7jyn84p" path="res://assets/textures/dev/grids/Dark/texture_07.png" id="1_11eju"]
[ext_resource type="Script" path="res://assets/scripts/world.gd" id="1_hlwjx"]
[ext_resource type="Script" path="res://assets/scripts/Button.gd" id="2_ofi8s"]
[ext_resource type="Texture2D" uid="uid://bg42dbiocnea" path="res://assets/hdris/kloofendal_48d_partly_cloudy_puresky_2k.hdr" id="2_vbdgp"]
[ext_resource type="Script" path="res://assets/scripts/DoorController.gd" id="4_k2mdo"]

[sub_resource type="Shader" id="Shader_gv50e"]
code = "shader_type spatial;

// Higher values are smaller width.
uniform float outline_width : hint_range(0.0, 10.0, 0.1) = 5.0;

uniform vec4 base_color : source_color = vec4(1.0);

float fresnel(float amount, vec3 normal, vec3 view)
{
	return pow((1.0 - clamp(dot(normalize(normal), normalize(view)), 0.0, 1.0 )), amount);
}

void fragment()
{
	float basic_fresnel = fresnel(outline_width, NORMAL, VIW);
	basic_fresnel = step(0.5, basic_fresnel); //0.5 magic number seems to give the most intuitive control
	ALBEDO = base_color.rgb - basic_fresnel;
}"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_vk2s1"]
render_priority = 0
shader = SubResource("Shader_gv50e")

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_oehdr"]
next_pass = SubResource("ShaderMaterial_vk2s1")
albedo_texture = ExtResource("1_11eju")
uv1_triplanar = true

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_xth68"]
next_pass = SubResource("ShaderMaterial_vk2s1")
albedo_color = Color(0.592157, 0.592157, 0.592157, 1)
emission = Color(1, 1, 1, 1)
emission_energy_multiplier = 9.25
ao_enabled = true

[sub_resource type="CylinderMesh" id="CylinderMesh_7rlw5"]

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_vle8n"]
next_pass = SubResource("ShaderMaterial_vk2s1")
albedo_color = Color(0.639216, 0.152941, 0.160784, 1)
uv1_triplanar = true

[sub_resource type="GDScript" id="GDScript_8sg5l"]
script/source = "extends MeshInstance3D


# Just copy the \"_toggle_outline\" function and it should work in MOST cases (for more read the NOTICE below)

func _toggle_outline(value):
	var mesh_instance = $MeshInstance
	
	# loop trhow all materials attached to the MeshInstance and if they have a next_pass applied, toogle the shader_parameter \"enable\" = value
	for i in range(mesh_instance.get_surface_material_count()):
		if mesh_instance.get_surface_material(i).next_pass != null: # check if a next_pass is attached
			mesh_instance.get_surface_material(i).next_pass.set_shader_param(\"enable\", value) # apply new value for \"enable\"
	
"

[sub_resource type="Animation" id="Animation_nkw5f"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("MeshInstance3D:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector3(0, 0.6, 0)]
}

[sub_resource type="Animation" id="Animation_ispkb"]
resource_name = "pressed_button"
length = 0.4
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("MeshInstance3D:position")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 0.2, 0.4),
"transitions": PackedFloat32Array(2.17638, 2.17638, 2.17638),
"update": 0,
"values": [Vector3(0, 0.6, 0), Vector3(0, 0.51, 0), Vector3(0, 0.6, 0)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_8o26o"]
_data = {
"RESET": SubResource("Animation_nkw5f"),
"pressed_button": SubResource("Animation_ispkb")
}

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_b64qo"]
next_pass = SubResource("ShaderMaterial_vk2s1")
albedo_color = Color(0.564706, 0.564706, 0.564706, 1)
uv1_triplanar = true

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_t1rf8"]
next_pass = SubResource("ShaderMaterial_vk2s1")
albedo_color = Color(0.6, 0.113725, 0.121569, 1)
uv1_triplanar = true

[sub_resource type="Animation" id="Animation_jwl0j"]
length = 0.001
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("DoorMovible:size")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector3(0.25, 3.5442, 3.07892)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("DoorMovible:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0),
"transitions": PackedFloat32Array(1),
"update": 0,
"values": [Vector3(0, 1.53543, 1.99096)]
}

[sub_resource type="Animation" id="Animation_4l6ck"]
resource_name = "close_door"
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("DoorMovible:size")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 1),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector3(0.25, 3.544, 0), Vector3(0.25, 3.544, 3.079)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("DoorMovible:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 1),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector3(0, 3, 1.991), Vector3(0, 1.5, 1.991)]
}

[sub_resource type="Animation" id="Animation_sk472"]
resource_name = "open_door"
tracks/0/type = "value"
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/path = NodePath("DoorMovible:size")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/keys = {
"times": PackedFloat32Array(0, 1),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector3(0.25, 3.544, 3.079), Vector3(0.25, 3.544, 0)]
}
tracks/1/type = "value"
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/path = NodePath("DoorMovible:position")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/keys = {
"times": PackedFloat32Array(0, 1),
"transitions": PackedFloat32Array(1, 1),
"update": 0,
"values": [Vector3(0, 1.5, 1.991), Vector3(0, 3, 1.991)]
}

[sub_resource type="AnimationLibrary" id="AnimationLibrary_kkg6h"]
_data = {
"RESET": SubResource("Animation_jwl0j"),
"close_door": SubResource("Animation_4l6ck"),
"open_door": SubResource("Animation_sk472")
}

[sub_resource type="PanoramaSkyMaterial" id="PanoramaSkyMaterial_khvqf"]
panorama = ExtResource("2_vbdgp")

[sub_resource type="Sky" id="Sky_wo383"]
sky_material = SubResource("PanoramaSkyMaterial_khvqf")

[sub_resource type="Environment" id="Environment_kp6dy"]
background_mode = 2
sky = SubResource("Sky_wo383")
tonemap_mode = 2
glow_enabled = true

[node name="world" type="Node3D"]
script = ExtResource("1_hlwjx")

[node name="stage" type="Node3D" parent="."]

[node name="CSGBox3D" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 16.8094, -0.499998, 0.0167828)
use_collision = true
size = Vector3(57.7906, 1, 20)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D5" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -23.0043, -0.5, 0)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D6" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -23.0043, 0.232626, 20.5028)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D7" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -2.80519, 1.0467, 20.2892)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D9" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 36.1022, 7.96316, 21.3373)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D8" type="CSGBox3D" parent="stage"]
transform = Transform3D(0.93688, -0.349651, 0, 0.349651, 0.93688, 0, 0, 0, 1, 16.7352, 4.43693, 21.1696)
use_collision = true
size = Vector3(20, 1, 20)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D2" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 4.99916, 2.52977, -7.25001)
use_collision = true
size = Vector3(5.0923, 1, 5.05701)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D3" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -0.000844955, 1.89063, -7.25001)
use_collision = true
size = Vector3(5.0923, 1, 5.05701)
material = SubResource("StandardMaterial3D_oehdr")

[node name="CSGBox3D4" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -5.23134, 1.82456, -7.25001)
use_collision = true
size = Vector3(5.0923, 1, 5.05701)
material = SubResource("StandardMaterial3D_oehdr")

[node name="Button" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 22.9508, 0.535025, 1.0862)
use_collision = true
size = Vector3(0.5, 1.08983, 0.5)
material = SubResource("StandardMaterial3D_xth68")
script = ExtResource("2_ofi8s")

[node name="MeshInstance3D" type="MeshInstance3D" parent="stage/Button"]
transform = Transform3D(0.25, 0, 0, 0, 0.05, 0, 0, 0, 0.25, 0, 0.6, 0)
mesh = SubResource("CylinderMesh_7rlw5")
skeleton = NodePath("../../..")
surface_material_override/0 = SubResource("StandardMaterial3D_vle8n")
script = SubResource("GDScript_8sg5l")

[node name="AnimationPlayer" type="AnimationPlayer" parent="stage/Button"]
libraries = {
"": SubResource("AnimationLibrary_8o26o")
}

[node name="Button2" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 26.9508, 0.535025, 1.0862)
use_collision = true
size = Vector3(0.5, 1.08983, 0.5)
material = SubResource("StandardMaterial3D_xth68")
script = ExtResource("2_ofi8s")

[node name="MeshInstance3D" type="MeshInstance3D" parent="stage/Button2"]
transform = Transform3D(0.25, 0, 0, 0, 0.05, 0, 0, 0, 0.25, 0, 0.6, 0)
mesh = SubResource("CylinderMesh_7rlw5")
skeleton = NodePath("../../..")
surface_material_override/0 = SubResource("StandardMaterial3D_vle8n")
script = SubResource("GDScript_8sg5l")

[node name="AnimationPlayer" type="AnimationPlayer" parent="stage/Button2"]
libraries = {
"": SubResource("AnimationLibrary_8o26o")
}

[node name="Door" type="Node3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 24.9379, 0, -2.87773)
script = ExtResource("4_k2mdo")

[node name="CSGBox3D2" type="CSGBox3D" parent="stage/Door"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.5, 0)
use_collision = true
size = Vector3(0.5, 3, 0.5)
material = SubResource("StandardMaterial3D_b64qo")

[node name="CSGBox3D3" type="CSGBox3D" parent="stage/Door"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1.5, 4)
use_collision = true
size = Vector3(0.5, 3, 0.5)
material = SubResource("StandardMaterial3D_b64qo")

[node name="CSGBox3D4" type="CSGBox3D" parent="stage/Door"]
transform = Transform3D(1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 3.26321, 1.99096)
use_collision = true
size = Vector3(0.5, 4.47206, 0.5)
material = SubResource("StandardMaterial3D_b64qo")

[node name="DoorMovible" type="CSGBox3D" parent="stage/Door"]
transform = Transform3D(1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 1.53543, 1.99096)
use_collision = true
size = Vector3(0.25, 3.5442, 3.07892)
material = SubResource("StandardMaterial3D_t1rf8")

[node name="AnimationPlayer" type="AnimationPlayer" parent="stage/Door"]
libraries = {
"": SubResource("AnimationLibrary_kkg6h")
}

[node name="CSGBox3D10" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 24.9472, 3.20614, -6.43084)
use_collision = true
size = Vector3(0.5, 6.43638, 6.75604)
material = SubResource("StandardMaterial3D_b64qo")

[node name="CSGBox3D11" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 24.9191, 3.21447, 5.59515)
use_collision = true
size = Vector3(0.5, 6.43638, 8.51446)
material = SubResource("StandardMaterial3D_b64qo")

[node name="CSGBox3D12" type="CSGBox3D" parent="stage"]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 24.9191, 4.94097, -0.860139)
use_collision = true
size = Vector3(0.5, 2.94513, 4.43971)
material = SubResource("StandardMaterial3D_b64qo")

[node name="env" type="Node3D" parent="."]

[node name="WorldEnvironment" type="WorldEnvironment" parent="env"]
environment = SubResource("Environment_kp6dy")

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="env"]
transform = Transform3D(-0.866025, -0.433013, 0.25, 0, 0.5, 0.866025, -0.5, 0.75, -0.433013, 0, 0, 0)
shadow_enabled = true

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="MainMenu" type="PanelContainer" parent="CanvasLayer"]
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 413.0
offset_top = 224.0
offset_right = -413.0
offset_bottom = -224.0
grow_horizontal = 2
grow_vertical = 2

[node name="MarginContainer" type="MarginContainer" parent="CanvasLayer/MainMenu"]
layout_mode = 2
theme_override_constants/margin_left = 15
theme_override_constants/margin_top = 15
theme_override_constants/margin_right = 15
theme_override_constants/margin_bottom = 15

[node name="VBoxContainer" type="VBoxContainer" parent="CanvasLayer/MainMenu/MarginContainer"]
layout_mode = 2
theme_override_constants/separation = 15

[node name="Label" type="Label" parent="CanvasLayer/MainMenu/MarginContainer/VBoxContainer"]
layout_mode = 2
text = "Main Menu"
horizontal_alignment = 1
vertical_alignment = 1

[node name="HostButton" type="Button" parent="CanvasLayer/MainMenu/MarginContainer/VBoxContainer"]
layout_mode = 2
text = "Host"

[node name="JoinButton" type="Button" parent="CanvasLayer/MainMenu/MarginContainer/VBoxContainer"]
layout_mode = 2
text = "Join"

[node name="AddressEntry" type="LineEdit" parent="CanvasLayer/MainMenu/MarginContainer/VBoxContainer"]
layout_mode = 2
placeholder_text = "localhost"
alignment = 1

[node name="MultiplayerSpawner" type="MultiplayerSpawner" parent="."]
_spawnable_scenes = PackedStringArray("res://assets/prefabs/player.tscn")
spawn_path = NodePath("..")

[connection signal="animation_finished" from="stage/Door/AnimationPlayer" to="stage/Door" method="_on_animation_player_animation_finished"]
[connection signal="animation_started" from="stage/Door/AnimationPlayer" to="stage/Door" method="_on_animation_player_animation_started"]
[connection signal="pressed" from="CanvasLayer/MainMenu/MarginContainer/VBoxContainer/HostButton" to="." method="_on_host_button_pressed"]
[connection signal="pressed" from="CanvasLayer/MainMenu/MarginContainer/VBoxContainer/JoinButton" to="." method="_on_join_button_pressed"]
